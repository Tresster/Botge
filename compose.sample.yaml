# @format

services:
  nginx:
    image: nginx:1.29.2-alpine
    mem_limit: 256m
    restart: always
    volumes:
      - ./nginx/cache:/var/www/cache:rw
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  meilisearch:
    ports:
      - 7700:7700
    image: getmeili/meilisearch:v1.24
    mem_limit: 512m
    healthcheck:
      test: set -o pipefail;curl -fsS http://localhost:7700/health | grep -q '{"status":"available"}'
      retries: 3
      timeout: 5s
    volumes:
      - ./meili_data:/meili_data
    environment:
      - MEILI_MASTER_KEY=SAMPLE_MASTER_KEY
      - MEILI_NO_ANALYTICS=true
      - MEILI_EXPERIMENTAL_REDUCE_INDEXING_MEMORY_USAGE
      - MEILI_EXPERIMENTAL_DUMPLESS_UPGRADE

  botge:
    depends_on:
      - nginx
      - meilisearch
    image: ghcr.io/tresster/botge:main
    # Comment image and uncomment build, and context for local compose.
    # `docker compose up --build`
    # build:
    #   context: .
    mem_limit: 512m
    restart: always
    volumes:
      - ./data:/app/data
      - ./tmp:/app/tmp
    environment:
      - NODE_ENV=production

      # discord
      - APP_ID=
      - DISCORD_TOKEN=

      # OpenAI - optional
      #- OPENAI_API_KEY=

      # Twitch - optional
      #- TWITCH_CLIENT_ID=
      #- TWITCH_SECRET=

      # MeiliSearch
      - MEILISEARCH_HOST=http://meilisearch:7700
      - MEILISEARCH_API_KEY=SAMPLE_MASTER_KEY

      # NGINX
      - LOCAL_CACHE_BASE=http://nginx:80

      # clips - optional
      - UPDATE_CLIPS_ON_STARTUP=true

      # embed server for Twitch, example: https://embedserver.com/t/ with / at the end - optional
      #- EMBED_SERVER_TWITCH=

      # embed server for Reddit, example: https://embedserver.com/r without / at the end - optional
      #- EMBED_SERVER_REDDIT=

      # Gemini - optional
      #- GEMINI_API_KEY=

      # Discord emojis. format: <:emoteName1:emoteId1>,<:emoteName2:emoteId2>
      #- DISCORD_EMOJIS=

      # join voice channel
      - JOIN_VOICE_CHANNEL=true
